name: Send Tech Trending Daily via Gmail

on:
  schedule:
    # Every day at UTC 11:00 (7:00 PM in UTC+8)
    - cron: '0 11 * * *'

  push:
    branches:
      - main

  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level'
        required: true
        default: 'warning'

jobs:
  send-email:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set current date with timezone
        id: current-date
        run: echo "CURRENT_DATE=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Get Trending Data
        uses: talljack/github-trending-email@main
        id: trending-repos
        env:
          token: ${{ secrets.GITHUB_TOKEN }}
        with:
          # GitHub Trending settings
          languages: '["", "typescript", "python", "go"]'
          dateRange: 'daily'
          # Extended features - set to 'false' to disable
          enableHuggingFace: 'true'
          enableHackerNews: 'true'
          enableDevTo: 'true'
          enableAIPapers: 'true'
          itemLimit: '10'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install yagmail

      # Send full trending email (new format)
      - name: Send trending email
        run: |
          python ./.github/actions/send_email.py \
            "${{ secrets.GMAIL_USERNAME }}" \
            "${{ secrets.GMAIL_PASSWORD }}" \
            "yugang.cao12@gmail.com" \
            "ðŸ”¥ Tech Trending Daily - $CURRENT_DATE" \
            ${{ steps.trending-repos.outputs.trendingData }}

      - name: Write github trending repos
        run: |
          python ./.github/actions/write_github_trending.py $CURRENT_DATE ${{ steps.trending-repos.outputs.githubTrendingRepos }}

      - name: Commit and push if changed
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add .
          git commit -m "Update GitHub trending repos" || exit 0
          git push
